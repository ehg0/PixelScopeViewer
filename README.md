# PixelScopeViewer

PySide6 (Qt6) で作られた、画素単位での画像向けの画像ビューア


## 特徴

- 複数画像の読み込みとナビゲーション
- ピクセル単位のROI作成編集
- ズーム機能 (+/- キー)
- ゲイン調整機能 (科学技術画像の輝度調整用、</> キー)
- ナビゲーターサムネイル (左クリックで表示領域を素早く移動)
- 解析機能
  - ヒストグラム (線形/対数表示切替)
  - プロファイル (水平/垂直/対角、相対/絶対座標)
  - メタデータ表示 (EXIF等の画像埋め込み情報)
  - 差分画像作成
  - 特徴量表示 (JSON/CSV 読み込み・表形式表示)
- CSV形式でのデータエクスポート

## インストール

### 必要要件

- Python 3.8 以上

### セットアップ

```powershell
# 依存パッケージのインストール
pip install -r requirements.txt
```

必須パッケージ:
- PySide6 (Qt for Python)
- numpy (配列処理)
- Pillow (画像読み込み)
- exifread (完全なEXIF情報読み取り)
- pyqtgraph (高速グラフ描画、ヒストグラム・プロファイル表示)
 - OpenImageIO (EXR/HDR 読み込み)
 - opencv-python (LDR画像の読み込みと変換)
 - pandas / polars (テーブル処理、特徴量ファイルの入出力)

## 使い方

### 起動

```powershell
python main.py
```

### 基本操作

1. **画像を開く**: `Ctrl+O` または メニュー > ファイル > 読み込み
2. **画像の切替**: `n` (次) / `b` (前)
3. **ROI作成**: マウス左ドラッグ
4. **ROI移動**: ROI内で右ドラッグ
5. **ROIリサイズ**: ROIの枠を左ドラッグ (角・辺をつかむ)
6. **ROI編集**: 矢印キー (画像1px移動)、Shift+矢印 (画像10px移動)
7. **解析表示**: メニュー > 解析 > Show Analysis

### キーボードショートカット

| キー | 動作 |
|------|------|
| `Ctrl+O` | 画像を開く |
| `Ctrl+A` | 画像全体をROI |
| `Ctrl+C` | ROIをコピー |
| `Ctrl+W` | 現在の画像を閉じる |
| `Ctrl+Shift+W` | すべての画像を閉じる |
| `矢印キー` | ROIを画像1px移動 |
| `Shift+矢印` | ROIを画像10px移動 |
| `n` | 次の画像 |
| `b` | 前の画像 |
| `+` | ズームイン |
| `-` | ズームアウト |
| `<` | ゲインを0.5倍 (暗く) |
| `>` | ゲインを2倍 (明るく) |
| `ESC` | ROI解除 |
| `f` | Fit / 直前の拡大率をトグル |
| `D` | 表示設定ダイアログ |
| `A` | 解析ダイアログ |
| `T` | 特徴量表示ダイアログ |
| `Ctrl+R` | 表示輝度をリセット (Offset/Gain/Saturation を初期値に戻す) |

#### 表示設定ダイアログのキー操作補足
- ダイアログ表示中でも `n`/`b` で画像切替が可能（アプリ全体ショートカット）。
- 数値入力中に `ESC` を押すと「入力のキャンセル（フォーカス解除）」を行い、ウィンドウは閉じません。
- `<`/`>` でゲインを 0.5x / 2x に変更できます（ゲインはスライダー範囲外の拡張値もスピンボックスで受け付け）。

### 解析機能

#### ヒストグラム
- 各チャンネルの輝度分布を表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **左ダブルクリック**: 線形/対数スケール切替
- **Channels...**: 表示するチャンネルを選択
- **Axis ranges...**: 軸範囲を手動設定
- **Copy data**: CSV形式でクリップボードにコピー

#### プロファイル
- ROIの平均輝度プロファイルを表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **左ダブルクリック**: 水平/垂直/対角 方向切替
- **右ダブルクリック**: 相対座標/絶対座標切替
- **Channels...**: 表示するチャンネルを選択
- **Axis ranges...**: 軸範囲を手動設定
- **Copy data**: CSV形式でクリップボードにコピー

#### メタデータ
- 画像ファイルの埋め込み情報を**表形式**で表示
- 基本情報: フォーマット、サイズ、カラーモード
- **完全なEXIF情報**: exifreadライブラリで包括的に読み取り
  - カメラ設定 (ISO, 絞り, シャッター速度など)
  - 撮影日時、GPS情報
  - レンズ情報、ホワイトバランス
  - Makernote以外のすべてのタグ
- その他のフォーマット固有情報
- 文字化けを防ぐエンコーディング処理 (UTF-8/Shift-JIS/CP932/Latin-1)
- **データコピー機能**:
  - **Ctrl+C**: 選択したセル/行/範囲をカンマ区切りでコピー
  - **「クリップボードにコピー」ボタン**: 全データをコピー
  - Excel/Google Spreadsheetsに貼り付け可能
- テキストブラウザでコピー&ペースト可能

#### 差分画像
- 2枚の画像の差分を計算
- オフセット値を指定可能 (デフォルト: 256)
- 計算式: `差分 = (画像A - 画像B) + オフセット`

#### 特徴量表示 (Features)
- メニュー > 解析 > 特徴量表示 からダイアログを開きます
- ダイアログ内メニューバー: 「ファイル > 特徴量ファイルを開く…」で JSON または CSV (Polars による自動判別) を読み込み
- タブ構成: Images / Categories / Annotations を表形式で表示
  - 各タブは列ヘッダクリックでソート可能 (初期ソート: Images/Categories は id 昇順, Annotations は image_id 昇順)
  - 数値は右寄せ表示、ツールチップに値を表示
  - ESC キー: ダイアログを閉じずに現在の選択のみ解除
- JSON保存: ダイアログ内から保存すると JSON をコンパクト整形（bbox 配列等を簡潔化）で出力。保存ダイアログは JSON を優先で表示し、最後に使ったフォルダを記憶します
- タイトルバー: 直近に読み込んだファイルパスを表示

サポートする JSON 形式（概要）:

```
{
  "dataset_name": "...",
  "categories": [ { "id": 1, "name": "..." }, ... ],
  "images": [
    {
      "id": 1,
      "file_name": "...",
      "width": 1920,
      "height": 1080,
      "metrics": { "psnr": 35.1, ... },
      "annotations": [ { "category_id": 1, "bbox": [x, y, w, h] }, ... ]
    },
    ...
  ]
}
```

CSV は Polars で読み込み、列の自動推定と並び替え/フィルタ表示に対応します。


## 技術仕様

### ゲイン調整機能
- ゲインを下げる (`<`): 値を0.5倍する (暗く表示)
- ゲインを上げる (`>`): 値を2倍する (明るく表示)
- ステータスバーには常に元の値を表示
- 解析は表示中(調整後)のデータで実行

### ROI
- 現在のズームレベルに基づいてピクセル境界にスナップ
- 座標は画像空間で保持 (ウィジェット空間ではない)
- ズーム変更時もROIを維持

### ナビゲーター
- サムネイル画像で現在の表示領域を可視化
- サムネイル上で左クリックすると、その位置を中心に表示領域が移動
- ズームや画像切り替え時も追従して更新

### 対応画像形式
浮動小数点型の場合、`[0, 1]`の範囲を想定して表示時に255倍される
- PNG
- JPEG
- TIFF
- BMP
- EXR (OpenEXR, HDR画像形式)
- NPY (NumPy配列)
  - 想定shape: `(height, width)` (グレースケール) または `(height, width, channels)` (マルチチャンネル)
  - チャンネル数: 1 (グレースケール), 3 (RGB), 4 (RGBA/RGBIR), 5以上もサポート
  - データ型: uint8, uint16, float32など



## アーキテクチャ

### コード構造 (2025年10月リファクタリング)

保守性向上のため、長大なファイルをモジュール化しました。

#### ディレクトリ構造

```
PixelScopeViewer/
├── main.py                    # エントリーポイント
├── tests/                     # テストコード
└── PixelScopeViewer/          # メインパッケージ
    ├── app.py                 # アプリケーション起動
    ├── core/                  # UI非依存ユーティリティ
    │   ├── image_io.py        # 画像I/O、EXIF読み取り
    │   └── metadata_utils.py  # メタデータ処理
    └── ui/                    # UIコンポーネント
        ├── utils/             # UI共通ユーティリティ (色設定等)
        ├── viewer/            # メインビューアウィンドウ
        ├── widgets/           # カスタムウィジェット (ROI、ナビゲーター等)
        └── dialogs/           # ダイアログウィンドウ
            ├── help_dialog.py    # ヘルプ
            ├── diff_dialog.py    # 差分画像
            ├── display/          # 表示設定 (輝度・チャンネル)
            ├── analysis/         # 解析 (ヒストグラム・プロファイル・メタデータ)
            └── features/         # 特徴量表示 (ダイアログ本体・モデル・プロキシ・デリゲート)
```

**設計原則**:
- **core/**: UI非依存の再利用可能なユーティリティ
- **ui/viewer/**: メインビューアとその管理クラス群
- **ui/widgets/**: 画像表示専用ウィジェット (Mixinパターン)
- **ui/dialogs/**: 各種ダイアログウィンドウ
  - **display/**: 表示設定 (輝度調整、チャンネル色設定)
  - **analysis/**: 解析機能 (ヒストグラム、プロファイル、メタデータ表示)
- **ui/dialogs/analysis/**: 解析機能のサブパッケージ (密結合したコンポーネント群)



## バージョン履歴

### v0.1.0 (2025-10-26)
- 初版作成