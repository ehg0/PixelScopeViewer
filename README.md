# PixelScopeViewer

PySide6 (Qt6) で作られた、画素単位での画像向けの画像ビューア


## 特徴

- 複数画像の読み込みとナビゲーション
- ピクセル単位のROI作成編集 (共通ROIは比較モードでオーバーレイ解析に連動)
- ズーム機能 (+/- キー)
- ゲイン調整機能 (科学技術画像の輝度調整用、</> キー)
- ナビゲーターサムネイル (左クリックで表示領域を素早く移動)
- 解析機能 (単一画像)
  - メタデータ表示 (EXIF等の画像埋め込み情報)
  - プロファイル (水平/垂直/対角、相対/絶対座標)
  - ヒストグラム (線形/対数表示切替)
  - 差分画像作成
  - 特徴量表示 (JSON/CSV 読み込み・表形式表示)
- 複数画像比較
  - タイリング表示された複数画像に対する統合ヒストグラムオーバーレイ (共通ビン)
  - プロファイルオーバーレイ (ROI変更で自動更新)
  - タイル×チャンネル単位の表示/非表示設定
  - 決定的色割り当て (Tableau 20 パレット, タイル番号とチャンネル番号に基づく)
  - グレースケールは常に C0 として扱う統一ラベリング
  - 統計行ラベル形式: Tn_Ck (例: T3_C2)
  - コピー/エクスポートは現在表示中の曲線のみ対象 (非表示チャンネル除外)
- CSV形式でのデータエクスポート (統合ヒストグラム/プロファイルも共通列長を保証)

## インストール

### 必要要件

- Python 3.8 以上

### セットアップ

```powershell
# 依存パッケージのインストール
pip install -r requirements.txt
```

必須パッケージ:
- PySide6 (Qt for Python)
- numpy (配列処理)
- exifread (完全なEXIF情報読み取り)
- pyqtgraph (高速グラフ描画、ヒストグラム・プロファイル表示)
 - OpenImageIO (EXR/HDR 読み込み)
 - opencv-python (LDR画像の読み込みと変換)
 - polars (テーブル処理、特徴量ファイルの入出力)

## 使い方

### 起動

```powershell
python main.py
```

### 基本操作

1. **画像を開く**: メニュー > ファイル > 画像ファイルを開く、または、ドラック&ドロップで画像読み込み
2. **画像の切替**: `n` (次) / `b` (前)
3. **ROI作成**: マウス左ドラッグ
4. **ROI移動**: ROI内で右ドラッグ
5. **ROIリサイズ**: ROIの枠を左ドラッグ (角・辺をつかむ)
6. **解析表示**: メニュー > 解析 > 解析ビュー

### キーボードショートカット

| キー | 動作 |
|------|------|
| `Ctrl+O` | 画像ファイルを開く |
| `Ctrl+A` | 画像全体をROI |
| `Ctrl+C` | ROIをコピー |
| `Ctrl+W` | 現在の画像を閉じる |
| `Ctrl+Shift+W` | すべての画像を閉じる |
| `矢印キー` | ROIを画像1px移動 |
| `Shift+矢印` | ROIを画像10px移動 |
| `ESC` | ROI解除 |
| `n` | 次の画像 |
| `b` | 前の画像 |
| `+` | ズームイン |
| `-` | ズームアウト |
| `f` | Fit / 直前の拡大率をトグル |
| `<` | ゲインを0.5倍 (暗く) |
| `>` | ゲインを2倍 (明るく) |
| `Ctrl+R` | 表示輝度をリセット (Offset/Gain/Saturation を初期値に戻す) |
| `D` | 表示設定 |
| `A` | 解析ビュー |
| `T` | 特徴量表示 |
| `Shift+T` | 複数画像比較 |


### 解析機能

#### ヒストグラム
- 各チャンネルの輝度分布を表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **右クリック**: グラフ設定オプション表示
- **Channels**: チェックボックスで表示するチャンネルを選択
- **Copy data / stas**: CSV形式でクリップボードにコピー

#### プロファイル
- ROIの平均輝度プロファイルを表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **右クリック**: グラフ設定オプション表示
- **Channels**: チェックボックスで表示するチャンネルを選択
- **Display Settings**: 水平/垂直 方向切替, 相対座標/絶対座標切替
- **Copy data / stas**: CSV形式でクリップボードにコピー

#### メタデータ
- 画像ファイルの埋め込み情報を**表形式**で表示
- 基本情報: フォーマット、サイズ、カラーモードなど
- **EXIF情報**: exifreadライブラリで包括的に読み取り


#### 差分画像
- 2枚の画像の差分を計算
- オフセット値を指定可能 (デフォルト: 127)
- 計算式: `差分 = (画像A - 画像B) + オフセット`

#### 特徴量表示 (Features)
- ダイアログ内メニューバー: 「ファイル > 特徴量ファイルを開く…」かドラッグ&ドロップで JSON または CSVを読み込み
- メニュー > 解析 > 特徴量表示 から開く
- タブ構成: Images / Categories / Annotations を表形式で表示
  - 各タブは列ヘッダクリックでソート可能 (初期ソートは id 昇順)
  - 未読み込みの画像を`fullfilepath`に基づいてロード
    - Imagesでは、`fullfilepath`のキーがない場合は、読み込みファイルがあるフォルダと"file_name" の値を結合して生成
    - `id`, `fullfilepath`のいずれかどちらかが将来的にImagesのPRIMARY KEYになることを想定


サポートする JSON 形式（概要）:

```
{
  "dataset_name": "...",
  "categories": [ { "id": 1, "name": "..." }, ... ],
  "images": [
    {
      "id": 1,
      "file_name": "test.jpeg",
      "width": 1920,
      "height": 1080,
      "metrics": { "psnr": 35.1, ... },
      "annotations": [ { "category_id": 1, "bbox": [x, y, w, h] }, ... ]
    },
    ...
  ]
}
```

### 複数画像比較

メニュー: 解析 > 複数画像比較 から複数画像をグリッド表示し、共通ROIを共有した解析を行います。

主な機能:
- データ型毎の表示輝度オフセット、飽和レベル調整 (ゲインは全タイル共通)
- 単一タイルへの解析機能
  - メイン画面同等。 ただし、色割り当ては初期状態固定。
- 複数タイルへの解析機能
  - 単一の解析機能を全タイル分オーバーレイ比較
    - チャンネル表示設定: 各タイルのチャンネル毎に表示/非表示を設定。非表示曲線は統計/コピーから除外。
    - 色割り当て: Tableau 20 パレットを (tile_index, channel_index) から生成。
    - ラベリング: グレースケールは C0。統計行と曲線ラベルは Tn_Ck 形式 (例: T1_C0, T2_C2)。


注意点:
- 非表示にしたチャンネルは Copy data/stats に含まれません。
- ROI未設定時、プロファイルは空で統計行も生成されません (安全なノーオペ)。
- グレースケールは内部的にチャンネル0として統一処理され、ヒスト/プロファイル選択判定が安定します。


## 技術仕様

### ゲイン調整機能
- ゲインを下げる (`<`): 値を0.5倍する (暗く表示)
- ゲインを上げる (`>`): 値を2倍する (明るく表示)
- ステータスバーには常に元の値を表示

### ROI
- 現在のズームレベルに基づいてピクセル境界にスナップ
- 座標は画像空間で保持 (ウィジェット空間ではない)
- ズーム変更時もROIを維持

### ナビゲーター
- サムネイル画像で現在の表示領域を可視化
- サムネイル上で左クリックすると、その位置を中心に表示領域が移動
- ズームや画像切り替え時も追従して更新

### 標準対応画像フォーマット
浮動小数点型の場合、`[0, 1]`の範囲を想定して表示時に255倍される
- PNG
- JPEG
- TIFF
- BMP
- EXR (OpenEXR, HDR画像形式)
- NPY (NumPy配列)
  - 想定shape: `(height, width)` (グレースケール) または `(height, width, channels)` (マルチチャンネル)
  - チャンネル数: 1 (グレースケール), 3 (RGB), 4 (RGBA/RGBIR)
  - データ型: uint8, uint16, float32など

### カスタムフォーマット対応（プラグイン機能）

**カスタムローダープラグイン**により、標準でサポートされていない画像フォーマットにも対応できます。

#### 概要
- 独自のバイナリ形式（.dat, .raw など）
- カスタム構造のNPZファイル
- その他の非標準フォーマット

これらのフォーマットに対応するため、ユーザーが独自のローダー関数を作成し、`custom_loaders/` ディレクトリに配置することで、アプリケーション起動時に自動的に読み込まれます。

#### 使い方
1. `custom_loaders/` ディレクトリに移動
2. サンプル (`_example_loader.py`) をコピーして新しいファイルを作成
3. ローダー関数を実装
4. アプリケーションを起動すると自動的に読み込まれます

**詳細は `custom_loaders/README.md` を参照してください。**

#### クイックスタート例

```python
# custom_loaders/my_loader.py
import numpy as np
from PixelScopeViewer.core.image_io import ImageLoaderRegistry

def my_custom_loader(path: str):
    if not path.endswith('.myformat'):
        return None
    # あなたの読み込み処理
    data = load_my_format(path)
    return data

# 登録
ImageLoaderRegistry.get_instance().register(
    my_custom_loader,
    extensions=['.myformat'],
    priority=10
)
```

これだけで `.myformat` ファイルが開けるようになります！

### マルチフレーム画像（4次元配列）の扱い

4次元配列 `(H, W, C, N)` を含むファイル（例: ビデオフレーム、時系列データ）を扱う場合は、事前展開ツールを使用してください。

#### 使い方

```powershell
# 4D配列を個別のフレームファイルに展開
python custom_loaders/multiframe/expand_multiframe.py input.npy output_frames/
```

これにより、`input.npy` (shape: H×W×C×N) が以下のように展開されます:
- `output_frames/frame_0000.npy`
- `output_frames/frame_0001.npy`
- `output_frames/frame_0002.npy`
- ...

その後、PixelScopeViewerでこれらのファイルをすべて開くことで、`n`/`b`キーでフレーム間を移動できます。

**詳細は `custom_loaders/multiframe/multiframe_guide.md` と `custom_loaders/multiframe/example_expand_multiframe.py` を参照してください。**



## アーキテクチャ

### コード構造
保守性向上のためモジュール化

#### ディレクトリ構造

```
PixelScopeViewer/
├── main.py                    # エントリーポイント
├── tests/                     # テストコード
└── PixelScopeViewer/          # メインパッケージ
    ├── app.py                 # アプリケーション起動
    ├── core/                  # UI非依存ユーティリティ
    │   ├── image_io.py        # 画像I/O、EXIF読み取り
    │   └── metadata_utils.py  # メタデータ処理
    └── ui/                    # UIコンポーネント
        ├── utils/             # UI共通ユーティリティ (色設定等)
        ├── viewer/            # メインビューアウィンドウ
        ├── widgets/           # カスタムウィジェット (ROI、ナビゲーター等)
        └── dialogs/           # ダイアログウィンドウ
            ├── help_dialog.py    # ヘルプ
            ├── diff_dialog.py    # 差分画像
            ├── display/          # 表示設定 (輝度・チャンネル)
            ├── analysis/         # 解析 (ヒストグラム・プロファイル・メタデータ)
            ├── features/         # 特徴量表示 (ダイアログ本体・モデル・プロキシ・デリゲート)
            └── tiling/           # 複数画像比較 (タイル表示・解析(オーバーレイ含む))
```


## バージョン履歴
### v0.2.1 (2025-11-18)
- ROI未設定時のフリーズ対策他

### v0.2.0 (2025-11-16)
- キャッシュ導入による拡大縮小時の描画高速化
- 複数画像比較機能の強化
  - 複数画像比較解析機能を追加
    - ヒストグラム / プロファイルオーバーレイ / メタデータ比較
  - ROI変更による比較オーバーレイ自動更新と安全な空データスキップ処理を実装
- ウィンドウ画面制御を統一 (親子関係の整理)
- 画面上の表示を統一 (有効桁数、余計な枠線の削除等)
- グラフの色ウォッチ、表示非表示を整備。
- 表記揺れをメンテナンス

### v0.1.6 (2025-11-14)
- カスタムフォーマットの画像ファイル読み込み用プラグイン機能追加
- 複数画像比較機能を試験的に追加

### v0.1.5 (2025-11-11)
- 特徴量テーブル表示の軽量化
- 追加表示される各ダイアログの最小化に対応
- 選択領域の対角長、ファイルサイズなど細かい表示機能追加

### v0.1.4 (2025-11-04)
- EXIFが表示されるように修正
- 2chはHSV色空間範囲を(-1.0~1.0の範囲)に対応変更

### v0.1.3 (2025-11-02)
- 画像チャンネル数毎に色の配色を選択可能
- 1chはjet, 2chはHSV色空間(-0.5~0.5の範囲)に対応

### v0.1.2 (2025-11-01)
- json読み込み機能を追加

### v0.1.1 (2025-10-31)
- 表示高速化

### v0.1.0 (2025-10-26)
- 初版作成