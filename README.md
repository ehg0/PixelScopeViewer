# PixelScopeViewer

PySide6 (Qt6) で作られた、画素単位での画像向けの画像ビューア


## 特徴

- 複数画像の読み込みとナビゲーション
- ピクセル単位のROI作成編集
- ズーム機能 (+/- キー)
- ゲイン調整機能 (科学技術画像の輝度調整用、</> キー)
- ナビゲーターサムネイル (左クリックで表示領域を素早く移動)
- 解析機能
  - ヒストグラム (線形/対数表示切替)
  - プロファイル (水平/垂直/対角、相対/絶対座標)
  - メタデータ表示 (EXIF等の画像埋め込み情報)
  - 差分画像作成
  - 特徴量表示 (JSON/CSV 読み込み・表形式表示)
- CSV形式でのデータエクスポート

## インストール

### 必要要件

- Python 3.8 以上

### セットアップ

```powershell
# 依存パッケージのインストール
pip install -r requirements.txt
```

必須パッケージ:
- PySide6 (Qt for Python)
- numpy (配列処理)
- exifread (完全なEXIF情報読み取り)
- pyqtgraph (高速グラフ描画、ヒストグラム・プロファイル表示)
 - OpenImageIO (EXR/HDR 読み込み)
 - opencv-python (LDR画像の読み込みと変換)
 - polars (テーブル処理、特徴量ファイルの入出力)

## 使い方

### 起動

```powershell
python main.py
```

### 基本操作

1. **画像を開く**: `Ctrl+O` または メニュー > ファイル > 読み込み
2. **画像の切替**: `n` (次) / `b` (前)
3. **ROI作成**: マウス左ドラッグ
4. **ROI移動**: ROI内で右ドラッグ
5. **ROIリサイズ**: ROIの枠を左ドラッグ (角・辺をつかむ)
6. **ROI編集**: 矢印キー (画像1px移動)、Shift+矢印 (画像10px移動)
7. **解析表示**: メニュー > 解析 > Show Analysis

### キーボードショートカット

| キー | 動作 |
|------|------|
| `Ctrl+O` | 画像を開く |
| `Ctrl+A` | 画像全体をROI |
| `Ctrl+C` | ROIをコピー |
| `Ctrl+W` | 現在の画像を閉じる |
| `Ctrl+Shift+W` | すべての画像を閉じる |
| `矢印キー` | ROIを画像1px移動 |
| `Shift+矢印` | ROIを画像10px移動 |
| `n` | 次の画像 |
| `b` | 前の画像 |
| `+` | ズームイン |
| `-` | ズームアウト |
| `<` | ゲインを0.5倍 (暗く) |
| `>` | ゲインを2倍 (明るく) |
| `ESC` | ROI解除 |
| `f` | Fit / 直前の拡大率をトグル |
| `D` | 表示設定ダイアログ |
| `A` | 解析ダイアログ |
| `T` | 特徴量表示ダイアログ |
| `Ctrl+R` | 表示輝度をリセット (Offset/Gain/Saturation を初期値に戻す) |

#### 表示設定ダイアログのキー操作補足
- ダイアログ表示中でも `n`/`b` で画像切替が可能（アプリ全体ショートカット）。
- 数値入力中に `ESC` を押すと「入力のキャンセル（フォーカス解除）」を行い、ウィンドウは閉じません。
- `<`/`>` でゲインを 0.5x / 2x に変更できます（ゲインはスライダー範囲外の拡張値もスピンボックスで受け付け）。

### 解析機能

#### ヒストグラム
- 各チャンネルの輝度分布を表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **右クリック**: グラフ設定オプション表示
- **Channels...**: 表示するチャンネルを選択
- **Copy data / stas**: CSV形式でクリップボードにコピー

#### プロファイル
- ROIの平均輝度プロファイルを表示
- **統計情報表示**: 平均値、標準偏差、最小値、最大値、中央値を各チャンネルごとに表示
- **右クリック**: グラフ設定オプション表示
- **Channels...**: 表示するチャンネルを選択
- **Display Settings**: 水平/垂直 方向切替, 相対座標/絶対座標切替
- **Copy data / stas**: CSV形式でクリップボードにコピー

#### メタデータ
- 画像ファイルの埋め込み情報を**表形式**で表示
- 基本情報: フォーマット、サイズ、カラーモードなど
- **EXIF情報**: exifreadライブラリで包括的に読み取り


#### 差分画像
- 2枚の画像の差分を計算
- オフセット値を指定可能 (デフォルト: 127)
- 計算式: `差分 = (画像A - 画像B) + オフセット`

#### 特徴量表示 (Features)
- ダイアログ内メニューバー: 「ファイル > 特徴量ファイルを開く…」かドラッグ&ドロップで JSON または CSVを読み込み
- メニュー > 解析 > 特徴量表示 からダイアログを開く
- タブ構成: Images / Categories / Annotations を表形式で表示
  - 各タブは列ヘッダクリックでソート可能 (初期ソートは id 昇順)
  - Imagesでは、"fullfilepath"のキーがない場合は、読み込みファイルがあるフォルダと"file_name" の値を結合して生成


サポートする JSON 形式（概要）:

```
{
  "dataset_name": "...",
  "categories": [ { "id": 1, "name": "..." }, ... ],
  "images": [
    {
      "id": 1,
      "file_name": "test.jpeg",
      "width": 1920,
      "height": 1080,
      "metrics": { "psnr": 35.1, ... },
      "annotations": [ { "category_id": 1, "bbox": [x, y, w, h] }, ... ]
    },
    ...
  ]
}
```

CSV は Polars で読み込み、列の自動推定と並び替え/フィルタ表示に対応します。


## 技術仕様

### ゲイン調整機能
- ゲインを下げる (`<`): 値を0.5倍する (暗く表示)
- ゲインを上げる (`>`): 値を2倍する (明るく表示)
- ステータスバーには常に元の値を表示
- 解析は表示中(調整後)のデータで実行

### ROI
- 現在のズームレベルに基づいてピクセル境界にスナップ
- 座標は画像空間で保持 (ウィジェット空間ではない)
- ズーム変更時もROIを維持

### ナビゲーター
- サムネイル画像で現在の表示領域を可視化
- サムネイル上で左クリックすると、その位置を中心に表示領域が移動
- ズームや画像切り替え時も追従して更新

### 対応画像形式
浮動小数点型の場合、`[0, 1]`の範囲を想定して表示時に255倍される
- PNG
- JPEG
- TIFF
- BMP
- EXR (OpenEXR, HDR画像形式)
- NPY (NumPy配列)
  - 想定shape: `(height, width)` (グレースケール) または `(height, width, channels)` (マルチチャンネル)
  - チャンネル数: 1 (グレースケール), 3 (RGB), 4 (RGBA/RGBIR)
  - データ型: uint8, uint16, float32など

### カスタムフォーマット対応（プラグイン機能）

PixelScopeViewerは、**カスタムローダープラグイン**により、標準でサポートされていない画像フォーマットにも対応できます。

#### 概要
- 独自のバイナリ形式（.dat, .raw など）
- カスタム構造のNPZファイル
- その他の非標準フォーマット

これらのフォーマットに対応するため、ユーザーが独自のローダー関数を作成し、`custom_loaders/` ディレクトリに配置することで、アプリケーション起動時に自動的に読み込まれます。

#### 使い方
1. `custom_loaders/` ディレクトリに移動
2. サンプル (`_example_loader.py`) をコピーして新しいファイルを作成
3. ローダー関数を実装
4. アプリケーションを起動すると自動的に読み込まれます

**詳細は `custom_loaders/README.md` を参照してください。**

#### クイックスタート例

```python
# custom_loaders/my_loader.py
import numpy as np
from PixelScopeViewer.core.image_io import ImageLoaderRegistry

def my_custom_loader(path: str):
    if not path.endswith('.myformat'):
        return None
    # あなたの読み込み処理
    data = load_my_format(path)
    return data

# 登録
ImageLoaderRegistry.get_instance().register(
    my_custom_loader,
    extensions=['.myformat'],
    priority=10
)
```

これだけで `.myformat` ファイルが開けるようになります！

### マルチフレーム画像（4次元配列）の扱い

4次元配列 `(H, W, C, N)` を含むファイル（例: ビデオフレーム、時系列データ）を扱う場合は、事前展開ツールを使用してください。

#### 使い方

```powershell
# 4D配列を個別のフレームファイルに展開
python custom_loaders/multiframe/expand_multiframe.py input.npy output_frames/
```

これにより、`input.npy` (shape: H×W×C×N) が以下のように展開されます:
- `output_frames/frame_0000.npy`
- `output_frames/frame_0001.npy`
- `output_frames/frame_0002.npy`
- ...

その後、PixelScopeViewerでこれらのファイルをすべて開くことで、`n`/`b`キーでフレーム間を移動できます。

**詳細は `custom_loaders/multiframe/multiframe_guide.md` と `custom_loaders/multiframe/example_expand_multiframe.py` を参照してください。**



## アーキテクチャ

### コード構造 (2025年10月リファクタリング)

保守性向上のため、長大なファイルをモジュール化しました。

#### ディレクトリ構造

```
PixelScopeViewer/
├── main.py                    # エントリーポイント
├── tests/                     # テストコード
└── PixelScopeViewer/          # メインパッケージ
    ├── app.py                 # アプリケーション起動
    ├── core/                  # UI非依存ユーティリティ
    │   ├── image_io.py        # 画像I/O、EXIF読み取り
    │   └── metadata_utils.py  # メタデータ処理
    └── ui/                    # UIコンポーネント
        ├── utils/             # UI共通ユーティリティ (色設定等)
        ├── viewer/            # メインビューアウィンドウ
        ├── widgets/           # カスタムウィジェット (ROI、ナビゲーター等)
        └── dialogs/           # ダイアログウィンドウ
            ├── help_dialog.py    # ヘルプ
            ├── diff_dialog.py    # 差分画像
            ├── display/          # 表示設定 (輝度・チャンネル)
            ├── analysis/         # 解析 (ヒストグラム・プロファイル・メタデータ)
            └── features/         # 特徴量表示 (ダイアログ本体・モデル・プロキシ・デリゲート)
```

**設計原則**:
- **core/**: UI非依存の再利用可能なユーティリティ
- **ui/viewer/**: メインビューアとその管理クラス群
- **ui/widgets/**: 画像表示専用ウィジェット (Mixinパターン)
- **ui/dialogs/**: 各種ダイアログウィンドウ
  - **display/**: 表示設定 (輝度調整、チャンネル色設定)
  - **analysis/**: 解析機能 (ヒストグラム、プロファイル、メタデータ表示)
- **ui/dialogs/analysis/**: 解析機能のサブパッケージ (密結合したコンポーネント群)



## バージョン履歴
### v0.1.5 (2025-11-11)
- 特徴量テーブル表示の軽量化
- 追加表示される各ダイアログの最小化に対応
- 選択領域の対角長、ファイルサイズなど細かい表示機能追加


### v0.1.4 (2025-11-04)
- EXIFが表示されるように修正
- 2chはHSV色空間範囲を(-1.0~1.0の範囲)に対応変更

### v0.1.3 (2025-11-02)
- 画像チャンネル数毎に色の配色を選択可能
- 1chはjet, 2chはHSV色空間(-0.5~0.5の範囲)に対応

### v0.1.2 (2025-11-01)
- json読み込み機能を追加

### v0.1.1 (2025-10-31)
- 表示高速化

### v0.1.0 (2025-10-26)
- 初版作成